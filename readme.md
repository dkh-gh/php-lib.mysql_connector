# MYSQL Connector

## информация
MYSQL Connector является модулем для ассинхронного общения с сервером и непосредственной записью в БД.  

### порядок работы
`запрос JS` > `стек JS` > `ассинхронный запрос` > `коннектор PHP` > `БД MySQL` > `стек JS` > `catcher JS`


## подключение к ресурсу

### серверная часть
- коннектор `lib/mysql_connector`, содержащий php файлы, расположить на сервере с доступом к MySQL БД
- настроить файл конфигураций `lib/mysql_connector/config.php`
- инициализировать базу данных

### клиентская часть
- подключить к странице скрипт `lib/mysql_connector/mysql_connector.js`
- создать и настроить свой JS коннектор
- создать  функцию для сбора ответов (catcher)

### lib/mysql_connector/config.php
Файл конфигураций коннектора. Содержит 
- `database` конфигурация подключения к БД
	- `host` URL хоста
	- `base` название БД
	- `user` имя пользователя БД
	- `pass` пароль пользователя
- `data` конфигурация данных в БД
	- `columns` поля для записи данных пользователями

и системные конфигурации
- `sql` шаблоны базовых запросов к таблицам
	- `get_user` запрос на получение данных авторизованного пользователя по имени
	- `get_user_by_skey` запрос на получение данных авторизованного пользователя по ключу
	- `get_users` запрос на получение списка всех пользователей
	- `update_skey` обновление ключа для авторизованного пользователя
- `ansvers` список шаблонов ответов сервера в формате JSON
	- `test_ok` тестовый положительный ответ
	- `mysql_connect_error` ошибка подключения к БД
	- `user_auth_error` ошибка авторизации пользователя
	- `no_user_data` не найдены данные пользователя
	- `ask_type_not_set` тип запроса не указан
	- `ask_type_not_found` нет такого типа ответа
	- `get_users_list` возврат списка пользователей
	- `get_user_data` возврат данных авторизованного пользователя
	- `get_user_dataset` получение всех данных пользователя
	- `get_user_dataset_last` получение последней по времени строки данных пользователя
	- `update_user_dataset` обновление последней строки данных пользователя по номеру

### инициализация базы данных
???

### создание и настройка своего JS коннектора
JS коннектор будет отвечать за отправку запросов и работу со стеком
создаётся с помощью создания нового экземпляра класса `MYSQL_Connector`.

	conn = new MYSQL_Connector();
	conn.configure({
		'connector_url': 'URL/TO/MYSQL_CONNECTOR.PHP',
		'catcher': FUNCTION_CATCHER_NAME,
		'user': 'USER_NAME',
		'passw': 'USER_PASSWORD',
	});

Имя пользователя и пароль можно задать позже, так же используя метод `.configure()`, но до отправки запросов.

### функция для сбора ответов (catcher)
Данная функция создаётся для получения и обработки вернувшихся от сервера ответов.  
Название функции может быть любым. Его нужно добавить в конфигурацию коннектора.

	function FUNCTION_CATCHER_NAME(data) {}

Функция вызывается коннектором при завершении какого-либо запроса и передаёт объект, указанный в примере как `data`.  
Структура объекта `data`, передаваемого коннектором:

	{
		???
	}


## запрос JS
Для создания запроса используется метод коннектора `.ask()`.  
Метод принимает 1 или 2 аргумента: `тип запроса` и `данные`.

### типы запросов 
Описываются в конфигурационном файле `lib/mysql_connector/config.php` в разделе `$config['ansvers']`:

| тип запроса | описание |
| --- | --- |
| test_ok | тестовый положительный ответ |
| mysql_connect_error | ошибка подключения к БД |
| user_auth_error | ошибка авторизации пользователя |
| no_user_data | не найдены данные пользователя |
| ask_type_not_set | тип запроса не указан |
| ask_type_not_found | нет такого типа ответа |
| get_users_list | возврат списка пользователей |
| get_user_data | возврат данных авторизованного пользователя |
| get_user_dataset | получение всех данных пользователя |
| get_user_dataset_last | получение последней по времени строки данных пользователя |
| update_user_dataset | обновление последней строки данных пользователя по номеру |

### данные
Передаются в виде второго аргумента при необходимости и представляют словарь из 2-х ключей: `key` - название столбца для изменения  и `value` - значение для столбца.

	{ 'key': 'COLUMN_NAME', 'value': 'COLUMN_VALUE', }

### пример запроса

запрос списка всех пользователей

	conn.ask('get_users_list');

обновление последней строки данных

	conn.ask('update_user_dataset', {
		'key': 'data1_100', 
		'value':mouse_sync['x'],
	});

## стек JS

Стек представляет собой хранилище запросов с их статусами и ответами сервера.  

### Структура стека

#### стек с объектом в момент отправки запроса

	stack_list = [
		{
			'timestamp': TIMESTAMP(int),
			'status': STATUS(str),
			'data': {
				'type': QUERY_ACTION(str),
				'data': {
					'key': KEY_NAME(str),
					'value': KEY_VALUE(str)
				}
			}
		},
		{ . . . },
		. . .
	]

- `stack_list` массив из запросов
	- `stack_list[i]` отдельный запрос
		- `timestamp` ключ-идентификатор для запроса в стеке и БД
		- `status` состояние запроса
			- `query` запрос отправлен, ожидается ответ 
			- `compleat` запрос вернулся с положительным ответом 
			- `failed` запрос вернулся с ошибкой
		- `data` данные, передаваемые коннектору
			- `key` название столбца для записи
			- `value` значение для записи


#### стек с объектом после ответа сервера

	stack_list = [
		{
			'timestamp': TIMESTAMP(int),
			'status': STATUS(str),
			'data': {
				'type': QUERY_ACTION(str),
				'data': {
					'key': KEY_NAME(str),
					'value': KEY_VALUE(str)
				}
			}
		},
		{ . . . },
		. . .
	]

- `stack_list` массив из запросов
	- `stack_list[i]` отдельный запрос
		- `timestamp` ключ-идентификатор для запроса в стеке и БД
		- `status` состояние запроса
			- `query` запрос отправлен, ожидается ответ 
			- `compleat` запрос вернулся с положительным ответом 
			- `failed` запрос вернулся с ошибкой
		- `data` данные, передаваемые коннектору
			- `key` название столбца для записи
			- `value` значение для записи

#### стек с объектом с ошибкой 

	stack_list = [
		{
			'timestamp': TIMESTAMP(int),
			'status': STATUS(str),
			'data': {
				'type': QUERY_ACTION(str),
				'data': {
					'key': KEY_NAME(str),
					'value': KEY_VALUE(str)
				}
			}
		},
		{ . . . },
		. . .
	]

- `stack_list` массив из запросов
	- `stack_list[i]` отдельный запрос
		- `timestamp` ключ-идентификатор для запроса в стеке и БД
		- `status` состояние запроса
			- `query` запрос отправлен, ожидается ответ 
			- `compleat` запрос вернулся с положительным ответом 
			- `failed` запрос вернулся с ошибкой
		- `data` данные, передаваемые коннектору
			- `key` название столбца для записи
			- `value` значение для записи


## catcher JS, свойства ответа, методы коннектора

Функция приёма ответа сервера позволяет получить данные, обработать статусы, и удалить данные из стека при ненадобности последующего хранения.



#### метод `.configure()`

Позволяет внести настройки в коннектор.
Принимает словарь из пар атрибут: значение.

	conn.configure({
		'ATTRIBUTE': 'VALUE',
		. . .
	});

| свойство | описание | ожидаемый тип данных |
| --- | --- | --- |
| connector_url | url адрес коннектора .php | string |
| catcher | пользовательская js функция сбора ответов сервера | function |
| user | имя пользователя в таблице пользователей | string |
| passw | пароль  пользователя в таблице пользователей | string |
| skey | ключ авторизации (заменяет логин/пароль, задаётся автоматически при успешной авторизации) | string |
  
  
